all: H.BIN

PSPSDK = $(shell psp-config --pspsdk-path)

CC	= psp-gcc
AS	= psp-as

INCDIR	= -I$(PSPSDK)/include -Iinclude -I.

CFLAGS	= $(INCDIR) -G1 -Os -Wall -Werror -mno-abicalls -fomit-frame-pointer -fno-pic -fno-strict-aliasing -fno-zero-initialized-in-bss
ASFLAGS = $(INCDIR)

ifdef NID_DEBUG
DEBUG = 1
CFLAGS += -DNID_DEBUG
endif
ifdef DEBUG
CFLAGS += -DDEBUG
endif

LDFLAGS = -O1 -G0

LIBDIR = -L$(PSPSDK)/lib

LIBS = libpspuser/libpspuser.a -lpspaudio -lpspdisplay -lpsputility

OBJS = common/stubs/syscall.o common/stubs/tables.o \
	common/utils/cache.o common/utils/fnt.o common/utils/scr.o common/utils/string.o \
	common/memory.o common/prx.o common/utils.o \
	loader/start.o loader/loader.o loader/bruteforce.o loader/freemem.o loader/runtime.o
ifdef DEBUG
OBJS += common/debug.o
endif

%.BIN: %.elf
	psp-objcopy -S -O binary -R .sceStub.text $< $@

H.elf: $(OBJS) loader.ld
	psp-ld $(LDFLAGS) -Tloader.ld $(LIBDIR) $(OBJS) $(LIBS) -o $@
	psp-fixup-imports $@

clean:
	rm -Rf $(OBJS) common/stubs/syscall.o common/debug.o svnversion.h H.elf H.BIN
