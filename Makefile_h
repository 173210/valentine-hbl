all: H.BIN

PSPSDK = $(shell psp-config --pspsdk-path)

# use a different FOLDER to make for different exploits
# Exploit-specific files go in the subfolders, see targets hbl and loader below
FOLDER_PATH = exploits/$(FOLDER)

CC	= psp-gcc
AS	= psp-as

INCDIR	= -I$(PSPSDK)/include -Iinclude -I$(FOLDER_PATH) -I.

CFLAGS	= $(INCDIR) -G1 -Os -Wall -Werror -mno-abicalls -fomit-frame-pointer -fno-pic -fno-strict-aliasing -fno-zero-initialized-in-bss

ifdef NID_DEBUG
DEBUG = 1
CFLAGS += -DNID_DEBUG
endif
ifdef DEBUG
CFLAGS += -DDEBUG
endif

LDFLAGS = -O1 -G0

LIBDIR = -L$(PSPSDK)/lib

LIBS = libpspuser/libpspuser.a -lpspaudio -lpspdisplay -lpsputility

OBJS = common/stubs/syscall.o common/stubs/tables.o \
	common/utils/cache.o common/utils/fnt.o common/utils/scr.o common/utils/string.o \
	common/memory.o common/prx.o common/utils.o \
	loader/loader.o loader/bruteforce.o loader/freemem.o loader/runtime.o
ifdef DEBUG
OBJS += common/debug.o
endif

LDADDR = $(FOLDER_PATH)/addr.ld

%.BIN: %.elf
	psp-objcopy -S -O binary -R .sceStub.text $< $@

H.elf: $(OBJS) $(LDADDR) loader.ld
	psp-ld $(LDFLAGS) -T$(LDADDR) -Tloader.ld $(LIBDIR) $(OBJS) $(LIBS) -o $@
	psp-fixup-imports $@

loader/loader.o: svnversion.h

#svn version in code
svnversion.h:
	-@echo "//svnversion.h is automatically generated by the Makefile!!!" > svnversion.h
	-@echo "" >> svnversion.h
	-@echo "#ifndef SVNVERSION" >> svnversion.h
	-@echo "#define SVNVERSION \"$(shell svnversion -n)\"" >> svnversion.h
	-@echo "#endif" >> svnversion.h
	-SubWCRev . svnversion.txt svnversion.h

clean:
	rm -Rf $(OBJS) common/stubs/syscall.o common/debug.o svnversion.h H.elf H.BIN
