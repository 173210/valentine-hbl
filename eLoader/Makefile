PSPSDK=$(shell psp-config --pspsdk-path)
PSPDEV=$(shell psp-config --pspdev-path)
INCLUDE=$(PSPSDK)/include

# make distrib to compile without debug info
# make or make dev to compile with debug info
all: dev
dev: CFLAGS += -D DEBUG -D NID_DEBUG
nonids: CFLAGS += -D DEBUG

clean:
	find . -name "*.o" -delete
	rm -rf *~ *.elf *.BIN

# use a different FOLDER to make for different exploits
# Exploit-specific files go in the subfolders, see targets hbl and loader below
FOLDER_PATH = exploits/$(FOLDER)

CC	= psp-gcc
AS	= psp-as

CFLAGS	:= -D PSP -I $(INCLUDE) -I $(FOLDER_PATH) -I . -Os -W -Wall -Werror -Wshadow -G0 -fno-pic -mno-abicalls -fomit-frame-pointer

#svn revision in code
SVNVERSION = $(shell svnversion -n 2)
base:
ifeq ($(SVNVERSION),)
#try windows with tortoise svn
	@echo svnrevision not found, trying SubWCRev
	@SubWCRev . svnversion.txt svnversion.h
else
	@echo "//svnversion.h is automatically generated by the Makefile!!!" > svnversion.h
	@echo "" >> svnversion.h
	@echo "#ifndef SVNVERSION" >> svnversion.h
	@echo "#define SVNVERSION \"$(SVNVERSION)\"" >> svnversion.h
	@echo "#endif" >> svnversion.h
endif

dev: base
nonids: base
distrib: base
base: HBL.BIN H.BIN

OBJS_COMMON = config.o debug.o globals.o lib.o malloc.o runtime_stubs.o utils.o

OBJS_HBL = $(OBJS_COMMON) $(FOLDER_PATH)/sdk_hbl.o \
	eloader.o elf.o memory.o modmgr.o syscall.o md5.o graphics.o font.o settings.o tables.o hook.o reloc.o resolve.o test.o

OBJS_LOADER = $(OBJS_COMMON) $(FOLDER_PATH)/sdk_loader.o \
	loader.o

%.BIN: %.elf
	psp-strip -O binary -s $< -o $@

HBL.elf: $(OBJS_HBL) $(FOLDER_PATH)/linker_hbl.x
	psp-ld -T $(FOLDER_PATH)/linker_hbl.x $(OBJS_HBL) -o $@

H.elf: $(OBJS_LOADER) $(FOLDER_PATH)/linker_loader.x
	psp-ld -T $(FOLDER_PATH)/linker_loader.x $(OBJS_LOADER) -o $@
